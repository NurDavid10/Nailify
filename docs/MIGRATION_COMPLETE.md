# Supabase to Express + Prisma Migration - COMPLETE

## Summary

Successfully migrated the Nails Booking App from Supabase to a custom Express.js backend with Prisma ORM and JWT authentication.

## What Was Changed

### Backend (NEW)
- ✅ Created `server/` directory with Express.js application
- ✅ Implemented Prisma ORM with PostgreSQL
- ✅ Built JWT-based authentication (bcrypt + jsonwebtoken)
- ✅ Created all API routes:
  - `/api/auth` - Login and user profile
  - `/api/treatments` - CRUD operations
  - `/api/availability` - Rules and time slots
  - `/api/appointments` - Atomic booking with race condition prevention
  - `/api/settings` - Settings management
  - `/api/admin/setup` - Initial admin creation

### Frontend (MODIFIED)
- ✅ Created `src/db/client.ts` - REST API client wrapper
- ✅ Rewrote `src/db/api.ts` - All 17 functions now use REST calls
- ✅ Rewrote `src/contexts/AuthContext.tsx` - JWT authentication
- ✅ Fixed `src/pages/LoginPage.tsx` - Removed Supabase imports
- ✅ Fixed `src/hooks/use-admin-setup.ts` - REST API call
- ✅ Deleted `src/db/supabase.ts` - No longer needed
- ✅ Updated `.env` - Removed Supabase vars, added VITE_API_URL
- ✅ Updated `package.json` - Removed @supabase/supabase-js

### Database (CLEANED)
- ✅ Removed RLS policies
- ✅ Removed Supabase functions (is_admin, handle_new_user, create_appointment_atomic)
- ✅ Removed triggers and views
- ✅ Disabled Row Level Security (handled in middleware now)

## Architecture

**Before:**
```
React SPA → Supabase Client SDK → Supabase Cloud
```

**After:**
```
React SPA → Express REST API → Prisma ORM → PostgreSQL (Docker)
           ↓
      JWT Auth (localStorage)
```

## How to Run

### 1. Start PostgreSQL (Docker)
```bash
docker start nails-booking-postgres
```

### 2. Setup Admin User
The admin setup endpoint will create a default admin on first run:
- Email: `admin@nailsbooking.local`
- Password: `ChangeMe123!` (from server/.env)

### 3. Start Both Servers
```bash
# Start both client and server concurrently
npm run dev

# Or start separately:
npm run dev:client  # Frontend on http://localhost:5173
npm run dev:server  # Backend on http://localhost:3001
```

### 4. Login
Navigate to http://localhost:5173/login and use the admin credentials.

## Critical Features Preserved

### ✅ Atomic Booking Transaction
The `createAppointment` function uses Prisma transactions with:
- Table locking (`LOCK TABLE appointments IN SHARE ROW EXCLUSIVE MODE`)
- Conflict detection (overlapping time slots)
- Serializable isolation level
- Prevents double-booking race conditions

### ✅ Time Slot Generation
- Ported from `src/db/api.ts` lines 84-160
- Supports multiple shifts per day
- Filters past slots for today
- Detects conflicts with booked appointments
- Returns ISO date strings (converted to Date objects in frontend)

### ✅ Multi-Language Support
- Treatment names preserved: `name_ar`, `name_he`, `name_en`
- Language context unchanged

### ✅ Admin Role Protection
- Middleware checks JWT token role
- Admin routes protected with `requireAdmin` middleware
- Public routes work without authentication

## Environment Variables

### Frontend (`.env`)
```
VITE_API_URL=http://localhost:3001/api
DATABASE_URL=postgresql://nails-booking-postgres:nails-booking-postgres@localhost:5432/nails-booking-postgres
```

### Backend (`server/.env`)
```
DATABASE_URL=postgresql://nails-booking-postgres:nails-booking-postgres@localhost:5432/nails-booking-postgres
JWT_SECRET=<auto-generated-secure-key>
JWT_EXPIRES_IN=7d
DEFAULT_ADMIN_EMAIL=admin@nailsbooking.local
DEFAULT_ADMIN_PASSWORD=ChangeMe123!
PORT=3001
NODE_ENV=development
CORS_ORIGIN=http://localhost:5173
```

## Testing Checklist

- [ ] Admin login
- [ ] Customer booking flow (4 steps)
- [ ] Treatments CRUD (admin)
- [ ] Availability management (admin)
- [ ] Appointment creation (public + admin)
- [ ] Appointment cancellation (admin)
- [ ] Settings management (admin)
- [ ] Atomic booking race condition (concurrent requests)
- [ ] JWT token expiration
- [ ] Logout

## Known Changes

1. **AuthContext API**: `user` field removed (was Supabase User type), kept only `profile`
2. **Date Serialization**: TimeSlot dates are ISO strings from API, converted to Date objects in `getAvailableTimeSlots`
3. **Error Messages**: May differ slightly from Supabase errors
4. **No Real-Time**: Removed Supabase real-time subscriptions (can add Socket.io if needed)

## Future Enhancements

- Add password reset functionality
- Implement email/SMS reminders (currently edge function only)
- Add user registration (currently admin-only)
- Add API rate limiting
- Add request logging middleware
- Add comprehensive error tracking

## Rollback Plan

If needed, revert by:
1. Checkout previous git commit
2. Restore `.env` with Supabase credentials
3. `npm install` to restore @supabase/supabase-js
4. Re-apply Supabase migrations

---

Migration completed on: February 14, 2026
